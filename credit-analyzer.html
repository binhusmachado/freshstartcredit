<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Report Analyzer - Client Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .content { padding: 30px; }
        
        /* Login Screen */
        .login-screen {
            text-align: center;
            padding: 60px 30px;
        }
        .login-screen h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .login-screen p {
            color: #666;
            margin-bottom: 30px;
        }
        .password-input {
            max-width: 400px;
            margin: 0 auto;
        }
        .password-input input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            letter-spacing: 3px;
        }
        .password-input input:focus {
            outline: none;
            border-color: #1e3c72;
        }
        .error-msg {
            color: #dc3545;
            margin-top: 15px;
            display: none;
        }
        
        /* Upload Section */
        .upload-area {
            border: 3px dashed #1e3c72;
            border-radius: 15px;
            padding: 50px 30px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }
        .upload-area:hover {
            background: #e9ecef;
            border-color: #2a5298;
        }
        .upload-area.dragover {
            background: #d1ecf1;
            border-color: #0c5460;
        }
        .upload-area .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .upload-area h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }
        .upload-area p {
            color: #666;
            font-size: 14px;
        }
        #fileInput { display: none; }
        
        /* Progress Bar */
        .progress-container {
            display: none;
            margin: 20px 0;
        }
        .progress-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
        }
        
        /* Analysis Results */
        .section { margin-bottom: 30px; }
        .section h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }
        textarea { resize: vertical; min-height: 100px; }
        
        /* Auto-Detected Items */
        .detected-item {
            background: white;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .detected-item.negative {
            border-left-color: #dc3545;
        }
        .detected-item.warning {
            border-left-color: #ffc107;
        }
        .detected-item h4 {
            color: #333;
            margin-bottom: 5px;
        }
        .detected-item p {
            color: #666;
            font-size: 14px;
        }
        
        /* Checkbox Groups */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 2px solid transparent;
        }
        .checkbox-item:hover { 
            background: #e9ecef; 
        }
        .checkbox-item.selected {
            background: #d1ecf1;
            border-color: #1e3c72;
        }
        .checkbox-item input {
            width: auto;
            margin-right: 10px;
            margin-top: 3px;
        }
        .checkbox-item .info {
            flex: 1;
        }
        .checkbox-item .info strong {
            display: block;
            color: #333;
            margin-bottom: 3px;
        }
        .checkbox-item .info small {
            color: #666;
            font-size: 12px;
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
            margin: 10px 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(30, 60, 114, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-group {
            text-align: center;
            margin-top: 30px;
        }
        
        /* Results Section */
        .results {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }
        .results h3 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        /* Letter Preview */
        .letter-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 30px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1e3c72;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #1e3c72;
        }
        .tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Logout Button */
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .header { position: relative; }
        
        /* File Preview */
        .file-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .file-preview img {
            max-width: 100%;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <h2>üîí Client Portal</h2>
            <p>Please enter the access code to continue</p>
            <div class="password-input">
                <input type="password" id="accessCode" placeholder="Enter Access Code" maxlength="20">
                <button class="btn" onclick="checkLogin()" style="margin-top: 20px;">Access Portal</button>
            </div>
            <p id="loginError" class="error-msg">Invalid access code. Please try again.</p>
            
            <p style="margin-top: 30px; color: #999; font-size: 12px;">
                Don't have an access code? Contact Fresh Start Credit at (305) 747-3973
            </p>
        </div>

        <!-- Main App (Hidden until login) -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
                <h1>üîç Credit Report Analyzer</h1>
                <p>Upload your credit report and we'll generate dispute letters</p>
            </div>
            
            <div class="content">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('upload')">üì§ Upload Report</div>
                    <div class="tab" onclick="switchTab('manual')">‚úèÔ∏è Manual Entry</div>
                </div>

                <!-- Upload Tab -->
                <div id="uploadTab" class="tab-content active">
                    <!-- File Upload Area -->
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="icon">üìÑ</div>
                        <h3>Click to Upload Credit Report</h3>
                        <p>or drag and drop files here</p>
                        <p style="margin-top: 15px; font-size: 12px; color: #999;">
                            Supported: PDF, JPG, PNG, HEIC (Max 10MB)
                        </p>
                    </div>
                    
                    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.heic" onchange="handleFileUpload(event)">
                    
                    <!-- Progress Bar -->
                    <div id="progressContainer" class="progress-container">
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill">0%</div>
                        </div>
                        <p id="progressText" class="progress-text">Uploading...</p>
                    </div>
                    
                    <!-- File Preview -->
                    <div id="filePreview" class="file-preview">
                        <h4>üìÑ Uploaded File</h4>
                        <div id="previewContent"></div>
                    </div>
                    
                    <!-- Extracted Text Preview -->
                    <div id="extractedTextSection" class="section hidden">
                        <h2>üìù Extracted Text Preview</h2>
                        <textarea id="extractedText" rows="10" placeholder="Extracted text will appear here..."></textarea>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">
                            ‚úèÔ∏è You can edit this text to correct any OCR errors before analysis
                        </p>
                    </div>
                    
                    <!-- Analyze Button -->
                    <div id="analyzeButtonSection" class="hidden" style="text-align: center;">
                        <button class="btn" onclick="analyzeUploadedReport()">ü§ñ Analyze Credit Report</button>
                    </div>
                </div>

                <!-- Manual Entry Tab -->
                <div id="manualTab" class="tab-content">
                    <form id="analyzerForm">
                        <!-- Client Info -->
                        <div class="section">
                            <h2>üìã Client Information</h2>
                            
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" id="clientName" required placeholder="John Smith">
                            </div>
                            
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="clientEmail" required placeholder="john@example.com">
                            </div>
                            
                            <div class="form-group">
                                <label>Address *</label>
                                <textarea id="clientAddress" required placeholder="123 Main St, Miami, FL 33101"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>SSN Last 4 *</label>
                                <input type="text" id="ssnLast4" maxlength="4" required placeholder="1234">
                            </div>
                        </div>

                        <!-- Negative Items -->
                        <div class="section">
                            <h2>‚ö†Ô∏è Select Negative Items Found</h2>
                            
                            <div class="checkbox-group" id="negativeItemsContainer">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="late_payment">
                                    <div class="info">
                                        <strong>Late Payments</strong>
                                        <small>30/60/90 day late marks</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="collections">
                                    <div class="info">
                                        <strong>Collections Accounts</strong>
                                        <small>Sent to collection agencies</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="charge_off">
                                    <div class="info">
                                        <strong>Charge-Offs</strong>
                                        <small>Creditor wrote off debt</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="repossession">
                                    <div class="info">
                                        <strong>Repossessions</strong>
                                        <small>Vehicle/property repossessed</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="foreclosure">
                                    <div class="info">
                                        <strong>Foreclosures</strong>
                                        <small>Home/property foreclosure</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="bankruptcy">
                                    <div class="info">
                                        <strong>Bankruptcies</strong>
                                        <small>Chapter 7 or 13 bankruptcy</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="tax_lien">
                                    <div class="info">
                                        <strong>Tax Liens</strong>
                                        <small>Unpaid tax liens</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="judgment">
                                    <div class="info">
                                        <strong>Judgments</strong>
                                        <small>Court judgments</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="negativeItems" value="hard_inquiry">
                                    <div class="info">
                                        <strong>Hard Inquiries</strong>
                                        <small>Unauthorized credit checks</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Error Types -->
                        <div class="section">
                            <h2>üîç Select Dispute Reasons</h2>
                            
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="errors" value="not_mine">
                                    <div class="info">
                                        <strong>üî¥ Not Mine / Identity Theft</strong>
                                        <small>Account doesn't belong to me</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="errors" value="date_inaccurate">
                                    <div class="info">
                                        <strong>üü° Dates Are Inaccurate</strong>
                                        <small>Wrong dates reported</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="errors" value="paid_still_reporting">
                                    <div class="info">
                                        <strong>üü° Paid But Still Negative</strong>
                                        <small>Account paid but showing negative</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="errors" value="duplicate_entry">
                                    <div class="info">
                                        <strong>üü° Duplicate Entry</strong>
                                        <small>Same account listed multiple times</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="errors" value="old_account">
                                    <div class="info">
                                        <strong>üü¢ Older Than 7 Years</strong>
                                        <small>Should be removed by law</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="errors" value="incorrect_balance">
                                    <div class="info">
                                        <strong>üü° Incorrect Balance</strong>
                                        <small>Balance amount is wrong</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="errors" value="unauthorized_inquiry">
                                    <div class="info">
                                        <strong>üü¢ Unauthorized Inquiry</strong>
                                        <small>I didn't authorize this credit check</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Account Details -->
                        <div class="section">
                            <h2>üè¢ Account Details</h2>
                            
                            <div class="form-group">
                                <label>Creditor Name *</label>
                                <input type="text" id="creditorName" required placeholder="Chase Bank, Capital One, etc.">
                            </div>
                            
                            <div class="form-group">
                                <label>Account Number</label>
                                <input type="text" id="accountNumber" placeholder="XXXX1234">
                            </div>
                            
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea id="additionalNotes" placeholder="Any other details about this account..."></textarea>
                            </div>
                        </div>

                        <!-- Credit Bureaus -->
                        <div class="section">
                            <h2>üìä Select Credit Bureaus</h2>
                            
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="bureaus" value="experian" checked>
                                    <div class="info">
                                        <strong>Experian</strong>
                                        <small>P.O. Box 4500, Allen, TX 75013</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="bureaus" value="equifax" checked>
                                    <div class="info">
                                        <strong>Equifax</strong>
                                        <small>P.O. Box 740256, Atlanta, GA 30374</small>
                                    </div>
                                </label>
                                
                                <label class="checkbox-item">
                                    <input type="checkbox" name="bureaus" value="transunion" checked>
                                    <div class="info">
                                        <strong>TransUnion</strong>
                                        <small>P.O. Box 2000, Chester, PA 19016</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn">üöÄ Generate Dispute Letters</button>
                        </div>
                    </form>
                </div>

                <!-- Results Section -->
                <div id="results" class="results">
                    <h3>üìà Analysis Results</h3>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-number" id="totalItems">0</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="highPriority">0</div>
                            <div class="stat-label">High Priority</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="disputable">0</div>
                            <div class="stat-label">Bureaus</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="estimatedGain">+50</div>
                            <div class="stat-label">Est. Score Gain</div>
                        </div>
                    </div>

                    <div id="detectedItems">
                        <h4>üéØ Items Detected for Dispute:</h4>
                        <div id="disputeList"></div>
                    </div>

                    <h3 style="margin-top: 30px;">üìù Generated Dispute Letters</h3>
                    
                    <p style="color: #666; margin-bottom: 20px;">
                        These letters are ready to print and mail. Each letter is customized for the specific bureau.
                    </p>
                    
                    <div id="letters"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Password protection
        const ACCESS_CODE = 'FreshStart2025';
        
        function checkLogin() {
            const enteredCode = document.getElementById('accessCode').value;
            if (enteredCode === ACCESS_CODE) {
                sessionStorage.setItem('creditAnalyzerLoggedIn', 'true');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('loginError').style.display = 'none';
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function logout() {
            sessionStorage.removeItem('creditAnalyzerLoggedIn');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('accessCode').value = '';
        }
        
        // Check if already logged in
        if (sessionStorage.getItem('creditAnalyzerLoggedIn') === 'true') {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }
        
        // Enter key on password field
        document.getElementById('accessCode')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkLogin();
        });
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // File Upload Handling
        let uploadedFile = null;
        let extractedText = '';
        
        const uploadArea = document.getElementById('uploadArea');
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('File too large. Maximum size is 10MB.');
                return;
            }
            
            uploadedFile = file;
            
            // Show preview
            const previewDiv = document.getElementById('filePreview');
            const previewContent = document.getElementById('previewContent');
            previewDiv.style.display = 'block';
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                previewContent.innerHTML = '';
                previewContent.appendChild(img);
            } else if (file.type === 'application/pdf') {
                previewContent.innerHTML = `<div style="padding: 40px; text-align: center;">
                    <div style="font-size: 48px;">üìÑ</div>
                    <p>${file.name}</p>
                    <p style="color: #666;">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>`;
            }
            
            // Start extraction
            extractTextFromFile(file);
        }
        
        async function extractTextFromFile(file) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            progressText.textContent = 'Starting text extraction...';
            
            try {
                if (file.type === 'application/pdf') {
                    await extractFromPDF(file, progressFill, progressText);
                } else if (file.type.startsWith('image/')) {
                    await extractFromImage(file, progressFill, progressText);
                } else {
                    throw new Error('Unsupported file type');
                }
                
                // Show extracted text section
                document.getElementById('extractedTextSection').classList.remove('hidden');
                document.getElementById('analyzeButtonSection').classList.remove('hidden');
                document.getElementById('extractedText').value = extractedText;
                
                progressText.textContent = '‚úÖ Extraction complete! Review the text and click Analyze.';
                
            } catch (error) {
                console.error('Extraction error:', error);
                progressText.textContent = '‚ùå Error: ' + error.message;
                progressFill.style.background = '#dc3545';
            }
        }
        
        async function extractFromPDF(file, progressFill, progressText) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            const totalPages = pdf.numPages;
            
            for (let i = 1; i <= totalPages; i++) {
                progressText.textContent = `Extracting page ${i} of ${totalPages}...`;
                const progress = (i / totalPages) * 50;
                progressFill.style.width = progress + '%';
                progressFill.textContent = Math.round(progress) + '%';
                
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            
            extractedText = fullText;
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
        }
        
        async function extractFromImage(file, progressFill, progressText) {
            progressText.textContent = 'Initializing OCR (this may take a minute)...';
            progressFill.style.width = '20%';
            
            const { createWorker } = Tesseract;
            const worker = await createWorker('eng');
            
            progressFill.style.width = '50%';
            progressText.textContent = 'Reading text from image...';
            
            const imageUrl = URL.createObjectURL(file);
            const { data: { text } } = await worker.recognize(imageUrl);
            
            await worker.terminate();
            
            extractedText = text;
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
        }
        
        function analyzeUploadedReport() {
            const text = document.getElementById('extractedText').value;
            if (!text.trim()) {
                alert('Please upload a file or enter text to analyze.');
                return;
            }
            
            // Auto-detect negative items from text
            const detectedItems = autoDetectNegativeItems(text);
            
            // Populate manual form with detected items
            populateFormWithDetectedItems(detectedItems);
            
            // Switch to manual tab to show results
            switchToManualTab();
            
            // Auto-check detected items
            checkDetectedItems(detectedItems);
            
            // Generate letters
            generateLetters();
        }
        
        function autoDetectNegativeItems(text) {
            const items = [];
            const lowerText = text.toLowerCase();
            
            // Detection patterns
            const patterns = {
                late_payment: /(30|60|90)\s*days?\s*late|past\s*due|delinquent|late\s*payment/i,
                collections: /collection|collected|debt\s*collector|placed\s*for\s*collection/i,
                charge_off: /charge[\s-]*off|charged\s*off|profit\s*and\s*loss/i,
                repossession: /repossession|repos|repo|repossessed/i,
                foreclosure: /foreclos|foreclosed|in\s*foreclosure/i,
                bankruptcy: /bankruptcy|chapter\s*(7|13)|discharged/i,
                tax_lien: /tax\s*lien|federal\s*tax\s*lien|state\s*tax\s*lien/i,
                judgment: /judgment|court\s*judgment|civil\s*judgment/i,
                hard_inquiry: /hard\s*inquiry|credit\s*inquiry|inquiry\s*date/i
            };
            
            for (const [type, pattern] of Object.entries(patterns)) {
                if (pattern.test(lowerText)) {
                    items.push(type);
                }
            }
            
            // Try to extract creditor names
            const creditorMatch = text.match(/(?:creditor|lender|original\s*creditor|sold\s*to)[\s:]+([A-Z][A-Za-z\s&]+(?:Bank|Corp|Inc|LLC|Company|Financial|Credit|Capital|One|Chase|Wells\s*Fargo|Citi|Discover|Amex|American\s*Express)?)/i);
            if (creditorMatch) {
                document.getElementById('creditorName').value = creditorMatch[1].trim();
            }
            
            // Try to extract account numbers
            const accountMatch = text.match(/(?:account\s*#?|acct|account\s*number)[\s:]+([\d\-X]+)/i);
            if (accountMatch) {
                document.getElementById('accountNumber').value = accountMatch[1].trim();
            }
            
            return items;
        }
        
        function populateFormWithDetectedItems(items) {
            // Add analysis notes
            const notes = `Auto-detected from uploaded credit report:\n${items.map(i => '- ' + i.replace('_', ' ').toUpperCase()).join('\n')}`;
            document.getElementById('additionalNotes').value = notes;
        }
        
        function checkDetectedItems(items) {
            items.forEach(item => {
                const checkbox = document.querySelector(`input[name="negativeItems"][value="${item}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        function switchToManualTab() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('manualTab').classList.add('active');
        }
        
        // Letter Templates
        const letterTemplates = {
            experian: (data) => `Experian Consumer Services
P.O. Box 4500
Allen, TX 75013

Date: ${new Date().toLocaleDateString()}

Re: Credit Report Dispute
Name: ${data.clientName}
SSN: XXX-XX-${data.ssnLast4}
Address: ${data.clientAddress}

To Whom It May Concern:

I am writing to dispute the following information in my credit report:

CREDITOR: ${data.creditorName}
ACCOUNT #: ${data.accountNumber || 'See attached'}

REASON FOR DISPUTE:
${data.disputeReason}

${data.additionalNotes ? 'ADDITIONAL INFORMATION:\n' + data.additionalNotes + '\n\n' : ''}
Under the Fair Credit Reporting Act (FCRA), you are required to investigate this dispute within 30 days of receipt. I request that you:

1. Verify all information regarding this account
2. Delete the item if it cannot be verified
3. Correct any inaccurate information
4. Provide me with the results of your investigation
5. Send a free copy of my updated credit report

I have enclosed copies of my identification and proof of address for your records.

If you have any questions, please contact me at ${data.clientEmail} or by mail at the address above.

Thank you for your prompt attention to this matter.

Sincerely,

${data.clientName}

Enclosures:
- Copy of Government-Issued ID
- Copy of Utility Bill (Proof of Address)
- Copy of Credit Report showing disputed item`,

            equifax: (data) => `Equifax Information Services LLC
P.O. Box 740256
Atlanta, GA 30374-0256

Date: ${new Date().toLocaleDateString()}

Re: Credit Report Dispute
Name: ${data.clientName}
SSN: XXX-XX-${data.ssnLast4}
Address: ${data.clientAddress}

To Whom It May Concern:

I am writing to dispute the following information in my credit report:

CREDITOR: ${data.creditorName}
ACCOUNT #: ${data.accountNumber || 'See attached'}

REASON FOR DISPUTE:
${data.disputeReason}

${data.additionalNotes ? 'ADDITIONAL INFORMATION:\n' + data.additionalNotes + '\n\n' : ''}
Under the Fair Credit Reporting Act (FCRA), you are required to investigate this dispute within 30 days of receipt. I request that you:

1. Verify all information regarding this account
2. Delete the item if it cannot be verified
3. Correct any inaccurate information
4. Provide me with the results of your investigation
5. Send a free copy of my updated credit report

I have enclosed copies of my identification and proof of address for your records.

If you have any questions, please contact me at ${data.clientEmail} or by mail at the address above.

Thank you for your prompt attention to this matter.

Sincerely,

${data.clientName}

Enclosures:
- Copy of Government-Issued ID
- Copy of Utility Bill (Proof of Address)
- Copy of Credit Report showing disputed item`,

            transunion: (data) => `TransUnion LLC
Consumer Dispute Center
P.O. Box 2000
Chester, PA 19016-2000

Date: ${new Date().toLocaleDateString()}

Re: Credit Report Dispute
Name: ${data.clientName}
SSN: XXX-XX-${data.ssnLast4}
Address: ${data.clientAddress}

To Whom It May Concern:

I am writing to dispute the following information in my credit report:

CREDITOR: ${data.creditorName}
ACCOUNT #: ${data.accountNumber || 'See attached'}

REASON FOR DISPUTE:
${data.disputeReason}

${data.additionalNotes ? 'ADDITIONAL INFORMATION:\n' + data.additionalNotes + '\n\n' : ''}
Under the Fair Credit Reporting Act (FCRA), you are required to investigate this dispute within 30 days of receipt. I request that you:

1. Verify all information regarding this account
2. Delete the item if it cannot be verified
3. Correct any inaccurate information
4. Provide me with the results of your investigation
5. Send a free copy of my updated credit report

I have enclosed copies of my identification and proof of address for your records.

If you have any questions, please contact me at ${data.clientEmail} or by mail at the address above.

Thank you for your prompt attention to this matter.

Sincerely,

${data.clientName}

Enclosures:
- Copy of Government-Issued ID
- Copy of Utility Bill (Proof of Address)
- Copy of Credit Report showing disputed item`
        };
        
        // Form submission
        document.getElementById('analyzerForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            generateLetters();
        });
        
        function generateLetters() {
            // Collect form data
            const formData = {
                clientName: document.getElementById('clientName').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientAddress: document.getElementById('clientAddress').value,
                ssnLast4: document.getElementById('ssnLast4').value,
                creditorName: document.getElementById('creditorName').value,
                accountNumber: document.getElementById('accountNumber').value,
                additionalNotes: document.getElementById('additionalNotes').value
            };
            
            // Get selected items
            const negativeItems = Array.from(document.querySelectorAll('input[name="negativeItems"]:checked')).map(cb => cb.value);
            const errors = Array.from(document.querySelectorAll('input[name="errors"]:checked')).map(cb => cb.value);
            const bureaus = Array.from(document.querySelectorAll('input[name="bureaus"]:checked')).map(cb => cb.value);
            
            // Build dispute reason
            let disputeReason = '';
            if (errors.includes('not_mine')) {
                disputeReason = 'This account does not belong to me. I have no knowledge of this account and did not authorize it. This may be a case of identity theft or mixed files. I request immediate removal of this fraudulent account from my credit report.';
            } else if (errors.includes('date_inaccurate')) {
                disputeReason = 'The dates associated with this account are inaccurate and do not match my records. The incorrect dates are negatively impacting my credit score. Please verify and correct the dates or remove this account.';
            } else if (errors.includes('paid_still_reporting')) {
                disputeReason = 'This account has been paid in full/settled but is still reporting as negative on my credit report. I have enclosed proof of payment/settlement. Please update the status and remove the negative reporting.';
            } else if (errors.includes('duplicate_entry')) {
                disputeReason = 'This account appears multiple times on my credit report as duplicate entries. The duplicate reporting is lowering my credit score unfairly. Please remove the duplicate entries immediately.';
            } else if (errors.includes('old_account')) {
                disputeReason = 'This account is older than 7 years from the date of first delinquency and should no longer be reported on my credit report under the Fair Credit Reporting Act (FCRA). Please remove this outdated information immediately.';
            } else if (errors.includes('incorrect_balance')) {
                disputeReason = 'The balance reported for this account is incorrect. I have verified this with the creditor, and the reported amount does not match my records. Please verify and correct the balance or remove this account.';
            } else if (errors.includes('unauthorized_inquiry')) {
                disputeReason = 'I did not authorize this credit inquiry. I have no record of applying for credit with this company on the date indicated. Unauthorized inquiries lower my credit score unfairly. Please remove this inquiry immediately.';
            } else {
                disputeReason = 'I dispute the accuracy of the information reported for this account. Under the FCRA, I have the right to request verification of this information. Please verify all details and remove this item if it cannot be verified.';
            }
            
            formData.disputeReason = disputeReason;
            
            // Update stats
            document.getElementById('totalItems').textContent = negativeItems.length;
            document.getElementById('highPriority').textContent = errors.filter(e => ['identity_theft', 'not_mine', 'old_account'].includes(e)).length;
            document.getElementById('disputable').textContent = bureaus.length;
            
            // Calculate estimated score gain
            let estimatedGain = 0;
            if (negativeItems.includes('bankruptcy')) estimatedGain += 100;
            if (negativeItems.includes('collections')) estimatedGain += 30;
            if (negativeItems.includes('charge_off')) estimatedGain += 40;
            if (negativeItems.includes('late_payment')) estimatedGain += 20;
            if (negativeItems.includes('hard_inquiry')) estimatedGain += 5;
            document.getElementById('estimatedGain').textContent = '+' + Math.min(estimatedGain, 150);
            
            // Build dispute list
            let disputeHTML = '';
            negativeItems.forEach(item => {
                const labels = {
                    late_payment: { title: 'Late Payments', desc: 'Dispute late payment history', priority: 'medium' },
                    collections: { title: 'Collections Account', desc: 'Request validation and dispute', priority: 'high' },
                    charge_off: { title: 'Charge-Off', desc: 'Dispute as unverified', priority: 'high' },
                    repossession: { title: 'Repossession', desc: 'Dispute inaccurate reporting', priority: 'high' },
                    foreclosure: { title: 'Foreclosure', desc: 'Verify dates and status', priority: 'high' },
                    bankruptcy: { title: 'Bankruptcy', desc: 'Verify discharge dates', priority: 'medium' },
                    tax_lien: { title: 'Tax Lien', desc: 'Verify paid status', priority: 'medium' },
                    judgment: { title: 'Judgment', desc: 'Verify and dispute if inaccurate', priority: 'high' },
                    hard_inquiry: { title: 'Hard Inquiry', desc: 'Dispute unauthorized inquiries', priority: 'low' },
                    duplicate_account: { title: 'Duplicate Account', desc: 'Remove duplicate entries', priority: 'high' },
                    incorrect_balance: { title: 'Incorrect Balance', desc: 'Correct balance amount', priority: 'medium' },
                    unauthorized_account: { title: 'Unauthorized Account', desc: 'Identity theft - not my account', priority: 'high' }
                };
                
                const info = labels[item] || { title: item, desc: 'Dispute for removal', priority: 'medium' };
                const icons = { high: 'üî¥', medium: 'üü°', low: 'üü¢' };
                
                disputeHTML += `
                    <div class="detected-item ${info.priority}-priority">
                        <h4>${icons[info.priority]} ${info.title}</h4>
                        <p>${info.desc}</p>
                    </div>
                `;
            });
            
            document.getElementById('disputeList').innerHTML = disputeHTML || '<p>No items selected. Please select negative items above.</p>';
            
            // Generate letters for each bureau
            let lettersHTML = '';
            bureaus.forEach(bureau => {
                const letter = letterTemplates[bureau](formData);
                lettersHTML += `
                    <div style="margin-bottom: 40px;">
                        <h4>üì® ${bureau.toUpperCase()} Dispute Letter</h4>
                        <div class="letter-preview" id="letter-${bureau}">${letter}</div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-secondary" onclick="copyLetter('letter-${bureau}')">üìã Copy Text</button>
                            <button class="btn btn-success" onclick="downloadLetter('${bureau}', '${formData.creditorName.replace(/[^a-zA-Z0-9]/g, '_')}')">üíæ Download (.txt)</button>
                            <button class="btn btn-secondary" onclick="printLetter('${bureau}')">üñ®Ô∏è Print</button>
                            <button class="btn btn-danger" onclick="emailLetter('${bureau}', '${formData.clientEmail}')">üìß Email to Client</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('letters').innerHTML = lettersHTML;
            
            // Show results
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
            // Save to localStorage
            const analyses = JSON.parse(localStorage.getItem('creditAnalyses') || '[]');
            analyses.push({
                ...formData,
                negativeItems,
                errors,
                bureaus,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('creditAnalyses', JSON.stringify(analyses));
        }
        
        function copyLetter(elementId) {
            const letter = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(letter).then(() => {
                alert('‚úÖ Letter copied to clipboard!');
            });
        }
        
        function downloadLetter(bureau, creditor) {
            const letter = document.getElementById(`letter-${bureau}`).textContent;
            const blob = new Blob([letter], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Dispute_Letter_${bureau}_${creditor}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function printLetter(bureau) {
            const letterContent = document.getElementById(`letter-${bureau}`).textContent;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Dispute Letter - ${bureau.toUpperCase()}</title></head>
                <body style="font-family: 'Courier New', monospace; white-space: pre-wrap; padding: 40px;">
                    ${letterContent.replace(/\n/g, '<br>')}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function emailLetter(bureau, clientEmail) {
            const letter = document.getElementById(`letter-${bureau}`).textContent;
            const subject = encodeURIComponent(`Your Credit Dispute Letter - ${bureau.toUpperCase()}`);
            const body = encodeURIComponent(letter + '\n\n---\nGenerated by Fresh Start Credit Solutions\n(305) 747-3973 | fastbtimes@gmail.com');
            window.open(`mailto:${clientEmail}?subject=${subject}&body=${body}`);
        }
    </script>
</body>
</html>
