<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Credit Report Analyzer | Fresh Start Credit</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .content { padding: 30px; }
        
        /* Login Screen */
        .login-screen {
            text-align: center;
            padding: 60px 30px;
            max-width: 400px;
            margin: 0 auto;
        }
        .login-screen h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .password-input {
            max-width: 300px;
            margin: 0 auto;
        }
        .password-input input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 15px;
        }
        .password-input input:focus {
            outline: none;
            border-color: #1e3c72;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover { background: #2a5298; }
        .btn-accent { background: #48bb78; }
        .btn-accent:hover { background: #38a169; }
        .error-msg {
            color: #dc3545;
            margin-top: 15px;
            display: none;
        }
        .hidden { display: none !important; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .tab.active {
            background: #1e3c72;
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        /* Feature Cards */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #1e3c72;
        }
        .feature-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Strategy Cards */
        .strategy-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .strategy-card:hover {
            border-color: #1e3c72;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .strategy-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }
        .strategy-card h4 {
            color: #1e3c72;
            margin-bottom: 8px;
        }
        .strategy-card .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #ed8936;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        /* Letter Output */
        .letter-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Alert Boxes */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .alert-warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        .alert-danger {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        
        /* Bureau Cards */
        .bureau-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .bureau-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .bureau-card h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }
        .bureau-card a {
            display: inline-block;
            margin-top: 10px;
            color: #1e3c72;
            text-decoration: none;
            font-weight: 500;
        }
        
        /* Items List */
        .item-list {
            margin-top: 20px;
        }
        .item-row {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .item-row input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }
        .item-row label {
            flex: 1;
            cursor: pointer;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .tab { width: 100%; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <h2>üîí Credit Analyzer</h2>
            <p>Enter access code to continue</p>
            <div class="password-input">
                <input type="password" id="accessCode" placeholder="Enter Code" maxlength="20">
                <button class="btn" onclick="checkLogin()" style="width: 100%;">Access Portal</button>
            </div>
            <p id="loginError" class="error-msg">Invalid access code. Please try again.</p>
            <p style="margin-top: 30px; color: #999; font-size: 12px;">Need access? Call (305) 747-3973</p>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <h1>üå± AI Credit Report Analyzer</h1>
                <p>Upload your credit report and generate dispute letters</p>
                <button class="btn" onclick="logout()" style="position: absolute; top: 20px; right: 20px;">Logout</button>
            </div>

            <div class="content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('upload')">üì§ Upload Report</button>
                    <button class="tab" onclick="switchTab('manual')">‚úèÔ∏è Manual Entry</button>
                    <button class="tab" onclick="switchTab('client')">üë§ My Info</button>
                    <button class="tab" onclick="switchTab('strategies')">üéØ Strategies</button>
                    <button class="tab" onclick="switchTab('phantom')">üëª Phantom Bureaus</button>
                    <button class="tab" onclick="switchTab('letters')">üìù My Letters</button>
                </div>

                <!-- Upload Tab -->
                <div id="uploadTab" class="tab-content active">
                    <div class="alert alert-info">
                        <strong>üí° Tip:</strong> Upload your credit report from AnnualCreditReport.com. We support PDF, JPG, and PNG files.
                    </div>

                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
                        <h3>Click to Upload Credit Report</h3>
                        <p>or drag and drop files here</p>
                        <p style="color: #999; font-size: 14px; margin-top: 10px;">PDF, JPG, PNG (Max 10MB)</p>
                        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" style="display: none;" onchange="handleFileSelect(event)">
                    </div>

                    <div id="uploadStatus" class="hidden">
                        <div class="alert alert-info">
                            <strong>‚úÖ File uploaded:</strong> <span id="fileName"></span>
                        </div>
                        <div id="extractedItems" class="item-list hidden">
                            <h3>Detected Negative Items:</h3>
                            <div id="itemsList"></div>
                            <button class="btn btn-accent" onclick="generateLettersFromItems()" style="margin-top: 20px;">Generate Dispute Letters</button>
                        </div>
                    </div>
                </div>

                <!-- Manual Entry Tab -->
                <div id="manualTab" class="tab-content">
                    <h3>Manual Dispute Entry</h3>
                    
                    <div class="form-group">
                        <label>Account Type:</label>
                        <select id="itemType">
                            <option value="late_payment">Late Payment</option>
                            <option value="collection">Collection Account</option>
                            <option value="charge_off">Charge-Off</option>
                            <option value="inquiry">Hard Inquiry</option>
                            <option value="bankruptcy">Bankruptcy</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Creditor Name:</label>
                        <input type="text" id="creditorName" placeholder="e.g., Capital One">
                    </div>

                    <div class="form-group">
                        <label>Account Number (optional):</label>
                        <input type="text" id="accountNumber" placeholder="Last 4 digits">
                    </div>

                    <div class="form-group">
                        <label>Date Opened:</label>
                        <input type="month" id="dateOpened">
                    </div>

                    <div class="form-group">
                        <label>Date of First Delinquency:</label>
                        <input type="month" id="dateDelinquent">
                    </div>

                    <div class="form-group">
                        <label>Dispute Reason:</label>
                        <textarea id="disputeReason" placeholder="Describe why this item is inaccurate or should be removed..."></textarea>
                    </div>

                    <button class="btn btn-accent" onclick="addManualItem()">Add Item & Generate Letter</button>
                </div>

                <!-- Strategies Tab -->
                <div id="strategiesTab" class="tab-content">
                    <div class="alert alert-warning">
                        <strong>‚ö° Fast-Removal Strategies</strong><br>
                        These advanced methods can remove negative items faster than standard disputes.
                    </div>

                    <div class="strategy-grid">
                        <div class="strategy-card" onclick="selectStrategy('factual')">
                            <span class="badge">BEST SUCCESS RATE</span>
                            <h4>üìä Factual Disputing</h4>
                            <p>Point out specific inaccuracies in reporting. Most effective method.</p>
                            <p><strong>Best for:</strong> Late payments, collections, any errors</p>
                        </div>

                        <div class="strategy-card" onclick="selectStrategy('605b')">
                            <span class="badge">4-DAY REMOVAL</span>
                            <h4>üî• Section 605B Identity Theft</h4>
                            <p>If you've been a victim of ID theft or data breaches, bureaus MUST remove items within 4 days.</p>
                            <p><strong>Best for:</strong> Identity theft victims, data breach affected</p>
                        </div>

                        <div class="strategy-card" onclick="selectStrategy('ferpa')">
                            <span class="badge">STUDENT LOANS</span>
                            <h4>üéì FERPA Violation</h4>
                            <p>Student loans with FERPA privacy violations can be disputed for cancellation.</p>
                            <p><strong>Best for:</strong> Student loans, education debt</p>
                        </div>

                        <div class="strategy-card" onclick="selectStrategy('metro2')">
                            <span class="badge">TECHNICAL ATTACK</span>
                            <h4>üí• Metro 2 Format Error</h4>
                            <p>Attack technical data format errors. Forces automatic deletion.</p>
                            <p><strong>Best for:</strong> Any account with reporting errors</p>
                        </div>

                        <div class="strategy-card" onclick="selectStrategy('obsolete')">
                            <span class="badge">AUTOMATIC</span>
                            <h4>üìÖ 7-Year Rule</h4>
                            <p>Items over 7 years old (10 for bankruptcy) must be removed by law.</p>
                            <p><strong>Best for:</strong> Old negative items, obsolete accounts</p>
                        </div>

                        <div class="strategy-card" onclick="selectStrategy('state')">
                            <span class="badge">STATE LAW</span>
                            <h4>‚öñÔ∏è State Law Violation</h4>
                            <p>Cite state-specific consumer protection laws (FCCPA, Rosenthal Act, etc.)</p>
                            <p><strong>Best for:</strong> All states, often stronger than federal laws</p>
                        </div>
                    </div>
                </div>

                <!-- Phantom Bureaus Tab -->
                <div id="phantomTab" class="tab-content">
                    <div class="alert alert-danger">
                        <strong>‚ö†Ô∏è CRITICAL STEP</strong><br>
                        These 3 "phantom" bureaus feed data to the Big 3. If you don't freeze them, removed items will just reappear!
                    </div>

                    <div class="bureau-grid">
                        <div class="bureau-card">
                            <h4>üìä SageStream (LexisNexis)</h4>
                            <p>Alternative credit scoring bureau</p>
                            <a href="https://forms.sagestreamllc.com/#/opt-self" target="_blank">‚û°Ô∏è Freeze Here</a>
                        </div>

                        <div class="bureau-card">
                            <h4>üéØ Innovis</h4>
                            <p>Fourth major credit bureau</p>
                            <a href="https://www.innovis.com/securityFreeze/index" target="_blank">‚û°Ô∏è Freeze Here</a>
                        </div>

                        <div class="bureau-card">
                            <h4>üìã LexisNexis</h4>
                            <p>Public records aggregator</p>
                            <a href="https://consumer.risk.lexisnexis.com/freeze" target="_blank">‚û°Ô∏è Freeze Here</a>
                        </div>
                    </div>

                    <div class="alert alert-info" style="margin-top: 20px;">
                        <strong>‚úÖ Complete Protection Checklist:</strong><br>
                        For complete credit protection, freeze ALL 6 bureaus:
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Experian - experian.com/freeze</li>
                            <li>Equifax - equifax.com/personal/credit-report-services/credit-freeze</li>
                            <li>TransUnion - transunion.com/credit-freeze</li>
                            <li>SageStream (above)</li>
                            <li>Innovis (above)</li>
                            <li>LexisNexis (above)</li>
                        </ul>
                    </div>
                </div>

                <!-- Client Info Tab -->
                <div id="clientTab" class="tab-content">
                    <h3>üë§ Your Information</h3>
                    <p style="color: #666; margin-bottom: 20px;">Enter your details once and they will be included in all dispute letters automatically.</p>
                    
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="clientFullName" placeholder="John Doe">
                    </div>
                    
                    <div class="form-group">
                        <label>Street Address *</label>
                        <input type="text" id="clientAddress" placeholder="123 Main Street">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>City *</label>
                            <input type="text" id="clientCity" placeholder="Miami">
                        </div>
                        <div class="form-group">
                            <label>State *</label>
                            <input type="text" id="clientState" placeholder="FL" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ZIP *</label>
                            <input type="text" id="clientZip" placeholder="33101" maxlength="10">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Phone *</label>
                            <input type="tel" id="clientPhone" placeholder="(305) 555-1234">
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="clientEmail" placeholder="john@example.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>SSN Last 4 Digits *</label>
                        <input type="text" id="clientSSN" placeholder="1234" maxlength="4">
                    </div>
                    
                    <button class="btn btn-accent" onclick="saveClientInfo()">Save My Information</button>
                    
                    <div id="clientInfoSaved" class="alert alert-info hidden" style="margin-top: 20px;">
                        ‚úÖ Your information has been saved and will be included in all dispute letters.
                    </div>
                </div>

                <!-- Letters Tab -->
                <div id="lettersTab" class="tab-content">
                    <h3>Your Generated Dispute Letters</h3>
                    
                    <div id="lettersList">
                        <p style="color: #999; text-align: center; padding: 40px;">No letters generated yet. Upload a credit report or add items manually to generate letters.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PASSWORD
        const ACCESS_CODE = 'S250502m!@#';
        let selectedItems = [];
        let generatedLetters = [];
        let detectedItems = [];

        // Login Functions
        function checkLogin() {
            const input = document.getElementById('accessCode');
            const errorMsg = document.getElementById('loginError');
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (!input || !loginScreen || !mainApp) {
                console.error('Login elements not found');
                return;
            }
            
            if (input.value === ACCESS_CODE) {
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                sessionStorage.setItem('analyzerLoggedIn', 'true');
                loadClientInfo();
            } else {
                if (errorMsg) errorMsg.style.display = 'block';
                input.value = '';
                input.focus();
            }
        }

        function logout() {
            sessionStorage.removeItem('analyzerLoggedIn');
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            if (loginScreen && mainApp) {
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        }

        // Check if already logged in - wait for DOM
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('analyzerLoggedIn') === 'true') {
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                if (loginScreen && mainApp) {
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    loadClientInfo();
                }
            }
            
            // Setup enter key support
            const accessCodeInput = document.getElementById('accessCode');
            if (accessCodeInput) {
                accessCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') checkLogin();
                });
            }
        });

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // File Upload with Auto-Extraction
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('uploadStatus').classList.remove('hidden');
            document.getElementById('extractedItems').classList.add('hidden');

            // Show processing status
            const statusDiv = document.createElement('div');
            statusDiv.id = 'processingStatus';
            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = '<strong>‚è≥ Processing...</strong> Extracting data from your credit report. This may take a moment.';
            document.getElementById('uploadStatus').appendChild(statusDiv);

            try {
                let extractedText = '';

                if (file.type === 'application/pdf') {
                    extractedText = await extractTextFromPDF(file);
                } else if (file.type.startsWith('image/')) {
                    extractedText = await extractTextFromImage(file);
                }

                // Parse the extracted text for negative items
                detectedItems = parseCreditReport(extractedText);

                // Remove processing status
                statusDiv.remove();

                if (detectedItems.length === 0) {
                    document.getElementById('itemsList').innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No negative items detected automatically.</strong><br>
                            Please use the "Manual Entry" tab to add items manually.
                        </div>
                    `;
                } else {
                    let html = '<h4>Select items to dispute:</h4>';
                    detectedItems.forEach((item, index) => {
                        html += `
                            <div class="item-row">
                                <input type="checkbox" id="item${index}" value="${index}" checked>
                                <label for="item${index}">
                                    <strong>${item.type}</strong> - ${item.creditor}<br>
                                    <small style="color: #666;">
                                        ${item.accountNumber ? 'Account: ' + item.accountNumber + ' | ' : ''}
                                        ${item.dateOpened ? 'Opened: ' + item.dateOpened + ' | ' : ''}
                                        ${item.balance ? 'Balance: $' + item.balance : ''}
                                    </small>
                                </label>
                            </div>
                        `;
                    });
                    document.getElementById('itemsList').innerHTML = html;
                }

                document.getElementById('extractedItems').classList.remove('hidden');

            } catch (error) {
                console.error('Extraction error:', error);
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = '<strong>‚ùå Error processing file.</strong> Please try again or use Manual Entry.';
            }
        }

        // Extract text from PDF
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }

            return fullText;
        }

        // Extract text from image using OCR
        async function extractTextFromImage(file) {
            const result = await Tesseract.recognize(file, 'eng', {
                logger: m => console.log(m)
            });
            return result.data.text;
        }

        // Parse credit report text for negative items
        function parseCreditReport(text) {
            const items = [];
            const lowerText = text.toLowerCase();

            // Look for collections
            const collectionPatterns = [
                /collection\s*(?:agency|account)?[\s:]*([A-Z][A-Za-z\s&.,]+?)(?=\s+(?:account|date|status|$))/gi,
                /([A-Z][A-Za-z\s&.,]+collection[A-Za-z\s&.,]*?)(?=\s+(?:account|date|status|$))/gi,
                /(collection[s]?)[\s:]+([^\n]+)/gi
            ];

            // Look for late payments
            const latePaymentPatterns = [
                /(\d+)\s*(?:day|days)?\s*late/i,
                /late\s*payment[s]?/gi,
                /past\s*due/gi,
                /delinquent/gi
            ];

            // Look for charge-offs
            const chargeOffPatterns = [
                /charge[\s-]*off/gi,
                /charged\s*off/gi
            ];

            // Look for inquiries
            const inquiryPatterns = [
                /hard\s*inquiry/gi,
                /credit\s*inquiry/gi,
                /inquiry\s+by[\s:]+([A-Z][A-Za-z\s&.,]+)/gi
            ];

            // Extract account numbers (typically XXXX-XXXX or last 4 digits)
            const accountNumberPattern = /(?:account\s*(?:#|number|num|no)[:\s]*)([X\d\-]{4,})/gi;

            // Extract dates (MM/DD/YYYY or MM-YYYY format)
            const datePattern = /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/g;

            // Extract balances ($X,XXX.XX format)
            const balancePattern = /\$?([\d,]+\.?\d{0,2})/g;

            // Process text line by line for better accuracy
            const lines = text.split('\n');
            
            lines.forEach((line, idx) => {
                const lowerLine = line.toLowerCase();
                let itemType = null;
                let creditor = null;

                // Detect item type
                if (collectionPatterns.some(p => {
                    const match = line.match(p);
                    if (match) {
                        creditor = match[1] || match[2] || match[0];
                        return true;
                    }
                    return false;
                })) {
                    itemType = 'Collection';
                } else if (chargeOffPatterns.some(p => lowerLine.match(p))) {
                    itemType = 'Charge-Off';
                } else if (latePaymentPatterns.some(p => lowerLine.match(p))) {
                    itemType = 'Late Payment';
                } else if (inquiryPatterns.some(p => {
                    const match = line.match(p);
                    if (match) {
                        creditor = match[1];
                        return true;
                    }
                    return false;
                })) {
                    itemType = 'Hard Inquiry';
                }

                // If we found an item type, extract more details
                if (itemType && !items.some(i => i.creditor === creditor && i.type === itemType)) {
                    // Look for creditor name if not already found
                    if (!creditor) {
                        // Try to extract creditor from the line or surrounding lines
                        const creditorMatch = line.match(/([A-Z][A-Za-z\s&.,]{2,50})(?:\s+(?:account|#|\d))/);
                        if (creditorMatch) {
                            creditor = creditorMatch[1].trim();
                        }
                    }

                    // Extract account number
                    const accountMatch = line.match(accountNumberPattern) || 
                                        (lines[idx + 1] && lines[idx + 1].match(accountNumberPattern));
                    const accountNumber = accountMatch ? accountMatch[1] : '';

                    // Extract date
                    const dateMatch = line.match(datePattern);
                    const dateOpened = dateMatch ? dateMatch[0] : '';

                    // Extract balance
                    const balanceMatch = line.match(balancePattern);
                    const balance = balanceMatch ? balanceMatch[1].replace(/,/g, '') : '';

                    if (creditor && creditor.length > 2) {
                        items.push({
                            type: itemType,
                            creditor: creditor.replace(/[^a-zA-Z0-9\s&.,]/g, '').trim(),
                            accountNumber: accountNumber,
                            dateOpened: dateOpened,
                            balance: balance,
                            reason: ''
                        });
                    }
                }
            });

            // Also do a broader search for creditors mentioned with negative keywords
            const creditorNames = text.match(/([A-Z][A-Z\s&.,]{3,50})(?:\s+(?:reported|balance|status))/g);
            if (creditorNames) {
                creditorNames.forEach(name => {
                    const cleanName = name.replace(/\s+(?:reported|balance|status).*/i, '').trim();
                    if (cleanName.length > 3 && !items.some(i => i.creditor === cleanName)) {
                        // Check if this creditor appears near negative keywords
                        const creditorIndex = text.indexOf(cleanName);
                        const surroundingText = text.substring(Math.max(0, creditorIndex - 200), 
                                                               Math.min(text.length, creditorIndex + 200)).toLowerCase();
                        
                        if (surroundingText.includes('collection') || 
                            surroundingText.includes('late') || 
                            surroundingText.includes('charge') ||
                            surroundingText.includes('past due')) {
                            items.push({
                                type: 'Negative Account',
                                creditor: cleanName,
                                accountNumber: '',
                                dateOpened: '',
                                balance: '',
                                reason: ''
                            });
                        }
                    }
                });
            }

            return items;
        }

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea?.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea?.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea?.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect({ target: { files: files } });
            }
        });

        // Store items globally for reference
        let detectedItems = [];

        // Generate Letters from Items
        function generateLettersFromItems() {
            const checkboxes = document.querySelectorAll('#itemsList input:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one item to dispute.');
                return;
            }

            checkboxes.forEach((cb) => {
                const itemIndex = parseInt(cb.value);
                const item = detectedItems[itemIndex];
                if (item) {
                    generateLetter({
                        type: item.type,
                        creditor: item.creditor,
                        accountNumber: item.accountNumber || '',
                        dateOpened: item.dateOpened || item.date || '',
                        dateDelinquent: item.dateDelinquent || '',
                        reason: item.reason || '',
                        strategy: 'factual'
                    });
                }
            });

            switchTab('letters');
            updateLettersList();
        }

        // Manual Item Entry
        function addManualItem() {
            const item = {
                type: document.getElementById('itemType').value,
                creditor: document.getElementById('creditorName').value,
                accountNumber: document.getElementById('accountNumber').value,
                dateOpened: document.getElementById('dateOpened').value,
                dateDelinquent: document.getElementById('dateDelinquent').value,
                reason: document.getElementById('disputeReason').value,
                strategy: 'factual'
            };

            if (!item.creditor) {
                alert('Please enter creditor name');
                return;
            }

            generateLetter(item);
            switchTab('letters');
            updateLettersList();

            // Reset form
            document.getElementById('itemType').selectedIndex = 0;
            document.getElementById('creditorName').value = '';
            document.getElementById('accountNumber').value = '';
            document.getElementById('dateOpened').value = '';
            document.getElementById('dateDelinquent').value = '';
            document.getElementById('disputeReason').value = '';
        }

        // Strategy Selection
        function selectStrategy(strategy) {
            document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Store selected strategy
            sessionStorage.setItem('selectedStrategy', strategy);
        }

        // Generate Dispute Letter
        function generateLetter(item) {
            // Get client info
            let clientInfo = {
                fullName: '[YOUR NAME]',
                address: '[YOUR STREET ADDRESS]',
                city: '[CITY]',
                state: '[STATE]',
                zip: '[ZIP]',
                phone: '[PHONE]',
                email: '[EMAIL]',
                ssn: '[SSN LAST 4]'
            };

            const savedInfo = sessionStorage.getItem('clientInfo');
            if (savedInfo) {
                clientInfo = JSON.parse(savedInfo);
            }

            // Get selected strategy
            const selectedStrategy = sessionStorage.getItem('selectedStrategy') || 'factual';

            const date = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Build strategy-specific content
            let strategyHeader = '';
            let strategyReason = '';
            let strategyLegal = '';
            let strategyRequest = '';

            switch(selectedStrategy) {
                case '605b':
                    strategyHeader = 'RE: Section 605B Identity Theft Report - FCRA ¬ß 605B';
                    strategyReason = `I am a victim of identity theft/fraud. This ${item.type} account with ${item.creditor} was opened fraudulently without my knowledge or authorization. I am reporting this as an identity theft incident under FCRA ¬ß 605B.`;
                    strategyLegal = 'Under FCRA ¬ß 605B(a)(1), you are required to block adverse information resulting from identity theft within 4 business days of receiving an appropriate identity theft report. This request constitutes such a report.';
                    strategyRequest = 'I demand that you block this information from my credit report within 4 business days as required by federal law. Failure to do so will result in immediate legal action.';
                    break;
                    
                case 'ferpa':
                    strategyHeader = 'RE: FERPA Violation - Student Loan Dispute';
                    strategyReason = `This ${item.type} account with ${item.creditor} involves educational records. I am disputing this item based on violations of the Family Educational Rights and Privacy Act (FERPA), 20 U.S.C. ¬ß 1232g.`;
                    strategyLegal = 'Under FERPA, educational institutions and loan servicers must comply with strict privacy requirements. Violations of FERPA may result in cancellation of the underlying debt. Under FCRA ¬ß 623(a)(5), furnishers must correct any information found to be inaccurate.';
                    strategyRequest = 'I request immediate investigation of FERPA violations and removal of this account if FERPA violations are confirmed.';
                    break;
                    
                case 'metro2':
                    strategyHeader = 'RE: Metro 2 Format Compliance Dispute';
                    strategyReason = `This ${item.type} account with ${item.creditor} contains Metro 2 reporting format errors that violate CDIA standards and FCRA accuracy requirements.`;
                    strategyLegal = 'Under Metro 2 guidelines and FCRA ¬ß 607(a), furnishers must maintain reasonable procedures to assure maximum possible accuracy. Metro 2 format errors constitute prima facie evidence of inaccurate reporting requiring immediate deletion.';
                    strategyRequest = 'I demand verification of Metro 2 compliance and deletion of this account if Metro 2 format errors are confirmed.';
                    break;
                    
                case 'obsolete':
                    strategyHeader = 'RE: Obsolete Account - FCRA ¬ß 605(a)';
                    strategyReason = `This ${item.type} account with ${item.creditor} exceeds the maximum reporting period of 7 years (or 10 years for bankruptcy) as established by FCRA ¬ß 605(a).`;
                    strategyLegal = 'Under FCRA ¬ß 605(a), consumer reporting agencies may not report accounts that predate the report by more than seven years (ten years for bankruptcy). Continued reporting of this obsolete item violates federal law.';
                    strategyRequest = 'I demand immediate deletion of this obsolete account as required by FCRA ¬ß 605(a). Continued reporting exposes you to statutory damages.';
                    break;
                    
                case 'state':
                    strategyHeader = 'RE: State Consumer Protection Law Violation';
                    strategyReason = `This ${item.type} account with ${item.creditor} violates state consumer protection laws including the Fair Credit Billing Act, state debt collection statutes, and common law duties of accuracy.`;
                    strategyLegal = 'In addition to federal FCRA requirements, state consumer protection laws (such as state FCBA equivalents, UDAP statutes, and common law negligence standards) impose additional duties of accuracy and reasonable investigation.';
                    strategyRequest = 'I demand compliance with both federal and applicable state consumer protection laws, including deletion if accuracy cannot be verified under the higher state standards.';
                    break;
                    
                case 'factual':
                default:
                    strategyHeader = 'RE: Factual Dispute - FCRA ¬ß 611';
                    strategyReason = item.reason || buildDefaultReason(item);
                    strategyLegal = 'Under FCRA ¬ß 611(a)(1)(A), you are required to conduct a reasonable investigation of this dispute within 30 days of receipt. Under FCRA ¬ß 607(a), you must follow reasonable procedures to assure maximum possible accuracy.';
                    strategyRequest = 'I request written confirmation of deletion or correction within 5 business days of completing your investigation.';
                    break;
            }

            // Build specific dispute reason if not using strategy
            function buildDefaultReason(item) {
                let reason = `I am disputing this ${item.type} account with ${item.creditor}. `;
                
                if (item.type === 'Late Payment') {
                    reason += `I dispute the reported late payment(s) as I have records showing payments were made on time. The reported delinquency is inaccurate and damaging my credit score.`;
                } else if (item.type === 'Collection') {
                    reason += `I do not recognize this collection account and request validation of the debt. If this debt is valid, I request proof of assignment from the original creditor.`;
                } else if (item.type === 'Charge-Off') {
                    reason += `I dispute the accuracy of this charge-off. I request verification of the date of first delinquency and the accuracy of the reported balance.`;
                } else if (item.type === 'Hard Inquiry') {
                    reason += `I did not authorize this credit inquiry. Please provide documentation showing my written authorization for this inquiry.`;
                } else {
                    reason += `This account contains inaccurate information. I request that you verify all details with the original creditor and remove this item if it cannot be verified.`;
                }
                return reason;
            }

            const letter = `${clientInfo.fullName}
${clientInfo.address}
${clientInfo.city}, ${clientInfo.state} ${clientInfo.zip}
Phone: ${clientInfo.phone}
Email: ${clientInfo.email}
SSN: XXX-XX-${clientInfo.ssn}

${date}

Experian
P.O. Box 4500
Allen, TX 75013

${strategyHeader}
Account: ${item.creditor}${item.accountNumber ? ' - Account #' + item.accountNumber : ''}

To Whom It May Concern:

I am writing to formally dispute inaccurate information appearing on my credit report.

CONSUMER INFORMATION:
Name: ${clientInfo.fullName}
Address: ${clientInfo.address}, ${clientInfo.city}, ${clientInfo.state} ${clientInfo.zip}
SSN: XXX-XX-${clientInfo.ssn}
Phone: ${clientInfo.phone}
Email: ${clientInfo.email}

ITEM DISPUTED:
- Creditor/Furnisher: ${item.creditor}
- Account Type: ${item.type}
- Account Number: ${item.accountNumber || 'Not Provided'}
- Date Opened: ${item.dateOpened || 'Unknown'}
${item.dateDelinquent ? '- Date of First Delinquency: ' + item.dateDelinquent + '\n' : ''}- Current Status: Reported as Negative/Adverse

SPECIFIC REASON FOR DISPUTE:
${strategyReason}

${strategyLegal}

REQUEST FOR INVESTIGATION:
I request that you conduct a complete investigation of this disputed item. Specifically, I request that you:

1. Contact the furnisher (${item.creditor}) to verify the accuracy of this account
2. Provide me with the results of your investigation within the statutory time period
3. Forward all documentation supporting the continued reporting of this item
4. If the furnisher cannot verify this information, delete it from my credit report immediately

${strategyRequest}

Thank you for your prompt attention to this matter.

Respectfully submitted,


_________________________________
${clientInfo.fullName}
Date: ${date}

Enclosures:
- Copy of Government-Issued Photo ID
- Copy of Social Security Card (showing last 4 digits: ${clientInfo.ssn})
- Copy of Recent Utility Bill (proving current address)
${selectedStrategy === '605b' ? '- Copy of Identity Theft Report/Police Report\n' : ''}${selectedStrategy === 'ferpa' ? '- Copy of Student Enrollment Records\n' : ''}

CC: Consumer Financial Protection Bureau (if unresolved)
     - file a complaint at consumerfinance.gov/complaint
            `.trim();

            generatedLetters.push({
                creditor: item.creditor,
                type: item.type,
                strategy: selectedStrategy,
                content: letter,
                date: new Date().toISOString()
            });
        }

SPECIFIC REASON FOR DISPUTE:
${specificReason}

REQUEST FOR INVESTIGATION:
I request that you conduct a complete investigation of this disputed item pursuant to 15 U.S.C. ¬ß 1681i(a)(1)(A). Specifically, I request that you:

1. Contact the furnisher (${item.creditor}) to verify the accuracy of this account
2. Provide me with the results of your investigation within 30 days
3. Forward all documentation supporting the continued reporting of this item
4. If the furnisher cannot verify this information, delete it from my credit report per FCRA ¬ß 611(a)(1)(B)

REMOVAL REQUEST:
If you cannot verify this information as accurate, complete, and verifiable, you are required by law to delete it from my credit report immediately. Pursuant to FCRA ¬ß 607(a), you must follow reasonable procedures to assure maximum possible accuracy of consumer reports.

I further request written confirmation of the deletion or correction of this item within 5 business days of completing your investigation.

AUTHORIZATION:
I authorize you to contact the creditor/furnisher listed above regarding this dispute. This is not a request for my credit file, but rather a formal dispute of specific information contained therein.

Thank you for your prompt attention to this matter.

Respectfully submitted,


_________________________________
${clientInfo.fullName}
Date: ${date}

Enclosures:
- Copy of Government-Issued Photo ID
- Copy of Social Security Card (showing last 4 digits: ${clientInfo.ssn})
- Copy of Recent Utility Bill (proving current address)
- ${item.type === 'Late Payment' || item.type === 'Collection' || item.type === 'Charge-Off' ? '- Any supporting documentation showing payment records or evidence of inaccuracy\n' : ''}

CC: Consumer Financial Protection Bureau (if unresolved)
            `.trim();

            generatedLetters.push({
                creditor: item.creditor,
                type: item.type,
                content: letter,
                date: new Date().toISOString()
            });
        }

        // Update Letters List
        function updateLettersList() {
            const container = document.getElementById('lettersList');
            
            if (generatedLetters.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No letters generated yet.</p>';
                return;
            }

            let html = '';
            generatedLetters.forEach((letter, index) => {
                html += `
                    <div style="margin-bottom: 30px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <div style="background: #1e3c72; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>${letter.creditor}</strong> - ${letter.type}</span>
                            <div>
                                <button class="btn" onclick="downloadPDF(${index})" style="width: auto; padding: 8px 16px; margin-right: 10px;">üìÑ PDF</button>
                                <button class="btn" onclick="downloadTXT(${index})" style="width: auto; padding: 8px 16px;">üìù TXT</button>
                            </div>
                        </div>
                        <div class="letter-output">${letter.content.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Download as TXT
        function downloadTXT(index) {
            const letter = generatedLetters[index];
            const blob = new Blob([letter.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dispute-letter-${letter.creditor.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Download as PDF
        function downloadPDF(index) {
            const letter = generatedLetters[index];
            const { jsPDF } = window.jspdf;
            
            const doc = new jsPDF({
                margin: 25,
                unit: 'mm',
                format: 'letter'
            });

            // Set font
            doc.setFont('times', 'normal');
            doc.setFontSize(11);

            // Parse letter content and add to PDF
            const lines = letter.content.split('\n');
            let y = 20;
            const lineHeight = 5;
            const margin = 25;
            const maxWidth = 170;

            lines.forEach(line => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                // Check if line is a header or important
                if (line.startsWith('RE:') || line.startsWith('ITEM DISPUTED') || line.startsWith('SPECIFIC REASON') || line.startsWith('REQUEST FOR') || line.startsWith('REMOVAL REQUEST')) {
                    doc.setFont('times', 'bold');
                } else {
                    doc.setFont('times', 'normal');
                }

                // Handle long lines
                const textLines = doc.splitTextToSize(line || ' ', maxWidth);
                textLines.forEach(textLine => {
                    doc.text(textLine, margin, y);
                    y += lineHeight;
                });

                // Add extra spacing after sections
                if (line === '' || line.startsWith('RE:') || line.startsWith('ITEM DISPUTED') || line.startsWith('SPECIFIC REASON') || line.startsWith('REQUEST FOR') || line.startsWith('REMOVAL REQUEST')) {
                    y += 2;
                }
            });

            // Save PDF
            doc.save(`dispute-letter-${letter.creditor.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}.pdf`);
        }

        // Client Info Functions
        function saveClientInfo() {
            const clientInfo = {
                fullName: document.getElementById('clientFullName').value,
                address: document.getElementById('clientAddress').value,
                city: document.getElementById('clientCity').value,
                state: document.getElementById('clientState').value,
                zip: document.getElementById('clientZip').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                ssn: document.getElementById('clientSSN').value
            };

            // Validate required fields
            if (!clientInfo.fullName || !clientInfo.address || !clientInfo.city || !clientInfo.state || !clientInfo.zip) {
                alert('Please fill in all required fields (marked with *).');
                return;
            }

            sessionStorage.setItem('clientInfo', JSON.stringify(clientInfo));
            document.getElementById('clientInfoSaved').classList.remove('hidden');
        }

        function loadClientInfo() {
            const saved = sessionStorage.getItem('clientInfo');
            if (saved) {
                const clientInfo = JSON.parse(saved);
                document.getElementById('clientFullName').value = clientInfo.fullName || '';
                document.getElementById('clientAddress').value = clientInfo.address || '';
                document.getElementById('clientCity').value = clientInfo.city || '';
                document.getElementById('clientState').value = clientInfo.state || '';
                document.getElementById('clientZip').value = clientInfo.zip || '';
                document.getElementById('clientPhone').value = clientInfo.phone || '';
                document.getElementById('clientEmail').value = clientInfo.email || '';
                document.getElementById('clientSSN').value = clientInfo.ssn || '';
                
                if (clientInfo.fullName) {
                    document.getElementById('clientInfoSaved').classList.remove('hidden');
                }
            }
        }

        // Load client info on page load
        if (sessionStorage.getItem('analyzerLoggedIn') === 'true') {
            loadClientInfo();
        }
    </script>
</body>
</html>